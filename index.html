<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexToon | Google Auth Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #6e8efb;
            --secondary: #a777e3;
            --danger: #ef4444;
            --success: #10b981;
            --dark: #1e293b;
            --light: #f1f5f9;
            --gray: #64748b;
        }
        
        body { font-family: 'Poppins', sans-serif; background: var(--light); margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .logout-btn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        .tab-container { display: flex; background: white; border-radius: 12px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); background: rgba(110, 142, 251, 0.05); }
        
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .admin-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--gray); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-family: inherit; outline: none; transition: 0.3s; }
        
        .btn-post { padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; }
        .btn-post:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .episode-row { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 15px; position: relative; }
        .ep-link-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .remove-btn { position: absolute; top: 10px; right: 10px; background: #fee2e2; color: #ef4444; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }

        .add-ep-btn { background: var(--dark); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        .content-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .content-card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; transition: 0.3s; }
        .content-poster { height: 180px; width: 100%; object-fit: cover; }
        .content-info { padding: 15px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 800px; border-radius: 15px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
        
        #status, #editStatus { margin-top: 15px; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; }
        .success-msg { background: #dcfce7; color: var(--success); border: 1px solid var(--success); }
        .filter-section { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border: 1px solid #cbd5e1; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-box" class="admin-card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <h2 style="margin-bottom: 10px;"><i class="fas fa-user-shield"></i> NexToon Admin</h2>
        <p style="color: var(--gray); margin-bottom: 25px;">Please login with your Google account to access the dashboard.</p>
        <button class="btn-post" onclick="handleGoogleLogin()">
            <i class="fab fa-google"></i> Login with Google
        </button>
    </div>

    <div id="main-ui" style="display: none;">
        <div class="header">
            <div>
                <h1><i class="fas fa-rocket"></i> NexToon Admin</h1>
                <small id="adminEmail" style="color: var(--primary); font-weight: 600;"></small>
            </div>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('add-content', this)">Add Content</div>
            <div class="tab" onclick="switchTab('manage-content', this)">Manage Content</div>
        </div>
        
        <div id="add-content" class="content-section active">
            <div class="admin-card">
                <h3>Create New Post</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Title *</label><input type="text" id="title" placeholder="Series Name"></div>
                    <div class="form-group"><label>Poster URL *</label><input type="text" id="image" placeholder="https://image-link.com"></div>
                    <div class="form-group"><label>Download Guide Link</label><input type="text" id="downloadGuide" placeholder="How to download video link"></div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="statusSelect">
                            <option value="Ongoing">Ongoing</option>
                            <option value="Finished">Finished</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Display Quality (Card Text)</label>
                        <select id="quality">
                            <option>Multi Quality</option>
                            <option>4K | Ultra HD</option>
                            <option>1080p | 10Bit</option>
                            <option>720p | HD</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Languages</label><input type="text" id="lang" placeholder="Hindi, English"></div>
                    <div class="form-group"><label>Genres</label><input type="text" id="genre" placeholder="Action, Adventure"></div>
                </div>
                <button class="btn-post" onclick="uploadToFirebase()">Publish Post</button>
                <div id="status"></div>
            </div>
        </div>
        
        <div id="manage-content" class="content-section">
            <div class="admin-card">
                <input type="text" id="searchBox" placeholder="Search by title..." onkeyup="loadAllContent()">
                <div id="contentContainer" class="content-list" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Edit Post & Episodes</h3>
            <span style="cursor:pointer; font-size:28px;" onclick="closeEditModal()">&times;</span>
        </div>
        <hr>
        <input type="hidden" id="editId">
        <div class="form-grid">
            <div class="form-group"><label>Title</label><input type="text" id="editTitle"></div>
            <div class="form-group"><label>Status</label>
                <select id="editStatusSelect">
                    <option value="Ongoing">Ongoing</option>
                    <option value="Finished">Finished</option>
                </select>
            </div>
            <div class="form-group"><label>Poster URL</label><input type="text" id="editImage"></div>
            <div class="form-group"><label>Guide Link</label><input type="text" id="editDownloadGuide"></div>
            <div class="form-group"><label>Quality</label><input type="text" id="editQuality"></div>
            <div class="form-group"><label>Languages</label><input type="text" id="editLang"></div>
            <div class="form-group"><label>Genres</label><input type="text" id="editGenre"></div>
        </div>

        <h3 style="margin-top:25px;">Episode Links</h3>
        <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: #f1f5f9; padding: 15px; border-radius: 8px;">
            <label style="margin:0;">Add New:</label>
            <select id="newEpType" style="width: auto;">
                <option value="multi">Full Multi (480p-4K)</option>
                <option value="4k">4K Only</option>
                <option value="1080p">1080p Only</option>
                <option value="720p">720p Only</option>
                <option value="480p">480p Only</option>
            </select>
            <button class="add-ep-btn" onclick="triggerAddEp()"><i class="fas fa-plus"></i> Add Episode</button>
        </div>

        <div class="filter-section">
            <label style="margin:0; min-width:max-content;"><i class="fas fa-filter"></i> Filter by Season:</label>
            <select id="seasonFilter" onchange="applySeasonFilter()">
                <option value="all">Show All Seasons</option>
            </select>
        </div>
        
        <div id="episodes-list"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 25px; position: sticky; bottom: 0; background: white; padding: 10px 0;">
            <button class="btn-post" style="flex: 2;" onclick="updateContent()">Update Everything</button>
            <button class="btn-post" style="background: var(--danger); flex: 1;" onclick="deleteContentConfirm()">Delete Post</button>
        </div>
        <div id="editStatus"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDpB4bszvFjBNC2WvhTSgFYf2Y0m_StVWM",
        authDomain: "oonj-def3e.firebaseapp.com",
        projectId: "oonj-def3e",
        storageBucket: "oonj-def3e.firebasestorage.app",
        messagingSenderId: "648217288200",
        appId: "1:648217288200:web:09001453584950b567fbbd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // EDIT THIS: Add your admin gmail here
    const authorizedEmails = ["your-email@gmail.com"]; 

    // Login function
    function handleGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                const user = result.user;
                if(authorizedEmails.includes(user.email)) {
                    showDashboard(user);
                } else {
                    alert("Unauthorized! You are not an admin.");
                    auth.signOut();
                }
            }).catch(e => alert(e.message));
    }

    // Check existing session
    auth.onAuthStateChanged((user) => {
        if (user && authorizedEmails.includes(user.email)) {
            showDashboard(user);
        } else {
            document.getElementById('login-box').style.display = 'block';
            document.getElementById('main-ui').style.display = 'none';
        }
    });

    function showDashboard(user) {
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';
        document.getElementById('adminEmail').innerText = "Logged in as: " + user.email;
        loadAllContent();
    }

    function logout() { auth.signOut().then(() => location.reload()); }

    function switchTab(tabId, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // Firebase Operations
    async function uploadToFirebase() {
        const statusDiv = document.getElementById('status');
        const title = document.getElementById('title').value;
        const image = document.getElementById('image').value;

        if(!title || !image) { alert("Title and Poster URL are required!"); return; }

        const data = {
            title: title,
            image: image,
            downloadGuide: document.getElementById('downloadGuide').value || "#",
            status: document.getElementById('statusSelect').value,
            quality: document.getElementById('quality').value,
            lang: document.getElementById('lang').value,
            genre: document.getElementById('genre').value,
            episodes: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
        };

        try {
            await db.collection('posts').add(data);
            statusDiv.innerHTML = "Success: Content Published!";
            statusDiv.className = "success-msg";
            document.getElementById('title').value = '';
            document.getElementById('image').value = '';
            loadAllContent();
            setTimeout(() => { statusDiv.innerHTML = ''; statusDiv.className = ''; }, 3000);
        } catch (e) { alert("Error: " + e.message); }
    }

    async function loadAllContent() {
        const container = document.getElementById('contentContainer');
        const search = document.getElementById('searchBox').value.toLowerCase();
        
        try {
            const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.title.toLowerCase().includes(search)) {
                    container.innerHTML += `
                    <div class="content-card">
                        <img src="${d.image}" class="content-poster" onerror="this.src='https://via.placeholder.com/300x180?text=No+Image'">
                        <div class="content-info">
                            <strong>${d.title}</strong><br>
                            <small style="color:var(--gray)">${d.status} | ${d.date}</small><br>
                            <button class="btn-post" style="padding:8px; margin-top:10px; font-size:13px;" onclick="openEditModal('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit Everything
                            </button>
                        </div>
                    </div>`;
                }
            });
        } catch (e) { console.log(e); }
    }

    // Episode Management Logic
    function triggerAddEp() {
        const type = document.getElementById('newEpType').value;
        const filterVal = document.getElementById('seasonFilter').value;
        const defaultSeason = filterVal === 'all' ? '1' : filterVal;
        addEpisodeRow('', '', '', '', '', '', type, defaultSeason);
        updateSeasonFilterUI();
        applySeasonFilter();
    }

    function addEpisodeRow(name = '', l480 = '', l720 = '', l1080 = '', l2k = '', l4k = '', type = 'multi', season = '1') {
        const div = document.createElement('div');
        div.className = 'episode-row';
        div.dataset.type = type;
        
        let seasonOptions = '';
        for(let i=1; i<=30; i++) {
            seasonOptions += `<option value="${i}" ${season == i ? 'selected' : ''}>Season ${i}</option>`;
        }
        
        let linkInputs = '';
        if(type === 'multi') {
            linkInputs = `
                <div class="ep-link-grid">
                    <input type="text" placeholder="480p Link" value="${l480}" class="ep-480">
                    <input type="text" placeholder="720p Link" value="${l720}" class="ep-720">
                    <input type="text" placeholder="1080p Link" value="${l1080}" class="ep-1080">
                    <input type="text" placeholder="2K Link" value="${l2k}" class="ep-2k">
                    <input type="text" placeholder="4K Link" value="${l4k}" class="ep-4k" style="grid-column: span 2;">
                </div>`;
        } else {
            const val = l480 || l720 || l1080 || l2k || l4k;
            linkInputs = `<div class="ep-link-grid"><input type="text" placeholder="${type.toUpperCase()} Link" value="${val}" class="ep-${type}" style="grid-column: span 2;"></div>`;
        }

        div.innerHTML = `
            <button class="remove-btn" onclick="removeEpRow(this)">Remove</button>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label>Season</label>
                    <select class="ep-season" onchange="updateSeasonFilterUI(); applySeasonFilter();">${seasonOptions}</select>
                </div>
                <div style="flex: 2;">
                    <label>Episode Name / Number</label>
                    <input type="text" placeholder="e.g. Episode 01" value="${name}" class="ep-name">
                </div>
            </div>
            ${linkInputs}
        `;
        document.getElementById('episodes-list').appendChild(div);
    }

    function updateSeasonFilterUI() {
        const seasonSelects = document.querySelectorAll('.ep-season');
        const filterDropdown = document.getElementById('seasonFilter');
        const currentFilter = filterDropdown.value;
        const seasons = new Set();
        seasonSelects.forEach(s => seasons.add(s.value));
        filterDropdown.innerHTML = '<option value="all">Show All Seasons</option>';
        Array.from(seasons).sort((a,b) => a-b).forEach(s => {
            filterDropdown.innerHTML += `<option value="${s}">Season ${s}</option>`;
        });
        filterDropdown.value = seasons.has(currentFilter) ? currentFilter : 'all';
    }

    function applySeasonFilter() {
        const filterVal = document.getElementById('seasonFilter').value;
        const rows = document.querySelectorAll('.episode-row');
        rows.forEach(row => {
            const rowSeason = row.querySelector('.ep-season').value;
            row.style.display = (filterVal === 'all' || rowSeason === filterVal) ? 'block' : 'none';
        });
    }

    function removeEpRow(btn) {
        btn.parentElement.remove();
        updateSeasonFilterUI();
        applySeasonFilter();
    }

    async function openEditModal(id) {
        const doc = await db.collection('posts').doc(id).get();
        const d = doc.data();
        document.getElementById('editId').value = id;
        document.getElementById('editTitle').value = d.title || '';
        document.getElementById('editImage').value = d.image || '';
        document.getElementById('editDownloadGuide').value = d.downloadGuide || '';
        document.getElementById('editStatusSelect').value = d.status || 'Ongoing';
        document.getElementById('editQuality').value = d.quality || '';
        document.getElementById('editLang').value = d.lang || '';
        document.getElementById('editGenre').value = d.genre || '';
        
        const epList = document.getElementById('episodes-list');
        epList.innerHTML = '';
        
        if(d.episodes) {
            d.episodes.forEach(ep => {
                let type = 'multi';
                let linkCount = [ep.link480, ep.link720, ep.link1080, ep.link2k, ep.link4k].filter(x => x).length;
                if(linkCount === 1) {
                    if(ep.link4k) type = '4k';
                    else if(ep.link1080) type = '1080p';
                    else if(ep.link720) type = '720p';
                    else if(ep.link480) type = '480p';
                }
                addEpisodeRow(ep.name, ep.link480||'', ep.link720||'', ep.link1080||'', ep.link2k||'', ep.link4k||'', type, ep.season || '1');
            });
        }
        updateSeasonFilterUI();
        applySeasonFilter();
        document.getElementById('editModal').classList.add('active');
    }

    async function updateContent() {
        const id = document.getElementById('editId').value;
        const rows = document.querySelectorAll('.episode-row');
        let episodesArray = [];

        rows.forEach(row => {
            const name = row.querySelector('.ep-name').value;
            const season = row.querySelector('.ep-season').value;
            if(name) {
                const type = row.dataset.type;
                let epObj = { name: name, season: season };
                if(type === 'multi') {
                    epObj.link480 = row.querySelector('.ep-480').value || "";
                    epObj.link720 = row.querySelector('.ep-720').value || "";
                    epObj.link1080 = row.querySelector('.ep-1080').value || "";
                    epObj.link2k = row.querySelector('.ep-2k').value || "";
                    epObj.link4k = row.querySelector('.ep-4k').value || "";
                } else {
                    const cleanType = type.replace('p', '');
                    epObj['link' + cleanType] = row.querySelector('.ep-' + type).value || "";
                }
                episodesArray.push(epObj);
            }
        });

        try {
            await db.collection('posts').doc(id).update({
                title: document.getElementById('editTitle').value,
                image: document.getElementById('editImage').value,
                downloadGuide: document.getElementById('editDownloadGuide').value,
                status: document.getElementById('editStatusSelect').value,
                quality: document.getElementById('editQuality').value,
                lang: document.getElementById('editLang').value,
                genre: document.getElementById('editGenre').value,
                episodes: episodesArray
            });
            const estatus = document.getElementById('editStatus');
            estatus.innerHTML = "Updated Successfully!";
            estatus.className = "success-msg";
            loadAllContent();
            setTimeout(() => { closeEditModal(); estatus.innerHTML = ''; estatus.className = ''; }, 1500);
        } catch (e) { alert("Error: " + e.message); }
    }

    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

    async function deleteContentConfirm() {
        if(confirm("Permanently delete this post?")) {
            await db.collection('posts').doc(document.getElementById('editId').value).delete();
            closeEditModal();
            loadAllContent();
        }
    }
</script>
</body>
</html>
                            <option>720p | HD</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Languages</label><input type="text" id="lang" placeholder="Hindi, English"></div>
                    <div class="form-group"><label>Genres</label><input type="text" id="genre" placeholder="Action, Adventure"></div>
                </div>
                <button class="btn-post" onclick="uploadToFirebase()">Publish Post</button>
                <div id="status"></div>
            </div>
        </div>
        
        <div id="manage-content" class="content-section">
            <div class="admin-card">
                <input type="text" id="searchBox" placeholder="Search by title..." onkeyup="loadAllContent()">
                <div id="contentContainer" class="content-list" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Edit Post & Episodes</h3>
            <span style="cursor:pointer; font-size:28px;" onclick="closeEditModal()">&times;</span>
        </div>
        <hr>
        <input type="hidden" id="editId">
        <div class="form-grid">
            <div class="form-group"><label>Title</label><input type="text" id="editTitle"></div>
            <div class="form-group"><label>Status</label>
                <select id="editStatusSelect">
                    <option value="Ongoing">Ongoing</option>
                    <option value="Finished">Finished</option>
                </select>
            </div>
            <div class="form-group"><label>Poster URL</label><input type="text" id="editImage"></div>
            <div class="form-group"><label>Guide Link</label><input type="text" id="editDownloadGuide"></div>
            <div class="form-group"><label>Quality</label><input type="text" id="editQuality"></div>
            <div class="form-group"><label>Languages</label><input type="text" id="editLang"></div>
            <div class="form-group"><label>Genres</label><input type="text" id="editGenre"></div>
        </div>

        <h3 style="margin-top:25px;">Episode Links</h3>
        <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: #f1f5f9; padding: 15px; border-radius: 8px;">
            <label style="margin:0;">Add New:</label>
            <select id="newEpType" style="width: auto;">
                <option value="multi">Full Multi (480p-4K)</option>
                <option value="4k">4K Only</option>
                <option value="1080p">1080p Only</option>
                <option value="720p">720p Only</option>
                <option value="480p">480p Only</option>
            </select>
            <button class="add-ep-btn" onclick="triggerAddEp()"><i class="fas fa-plus"></i> Add Episode</button>
        </div>

        <div class="filter-section">
            <label style="margin:0; min-width:max-content;"><i class="fas fa-filter"></i> Filter by Season:</label>
            <select id="seasonFilter" onchange="applySeasonFilter()">
                <option value="all">Show All Seasons</option>
            </select>
        </div>
        
        <div id="episodes-list"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 25px; position: sticky; bottom: 0; background: white; padding: 10px 0;">
            <button class="btn-post" style="flex: 2;" onclick="updateContent()">Update Everything</button>
            <button class="btn-post" style="background: var(--danger); flex: 1;" onclick="deleteContentConfirm()">Delete Post</button>
        </div>
        <div id="editStatus"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDpB4bszvFjBNC2WvhTSgFYf2Y0m_StVWM",
        authDomain: "oonj-def3e.firebaseapp.com",
        projectId: "oonj-def3e",
        storageBucket: "oonj-def3e.firebasestorage.app",
        messagingSenderId: "648217288200",
        appId: "1:648217288200:web:09001453584950b567fbbd"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function checkAuth() {
        const pass = document.getElementById('adminPass').value;
        if(pass === "admin123") {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            loadAllContent();
        } else { 
            alert("Access Denied! Incorrect Password."); 
        }
    }

    function logout() { location.reload(); }

    function switchTab(tabId, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    async function uploadToFirebase() {
        const statusDiv = document.getElementById('status');
        const title = document.getElementById('title').value;
        const image = document.getElementById('image').value;

        if(!title || !image) { alert("Title and Poster URL are required!"); return; }

        const data = {
            title: title,
            image: image,
            downloadGuide: document.getElementById('downloadGuide').value || "#",
            status: document.getElementById('statusSelect').value,
            quality: document.getElementById('quality').value,
            lang: document.getElementById('lang').value,
            genre: document.getElementById('genre').value,
            episodes: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
        };

        try {
            await db.collection('posts').add(data);
            statusDiv.innerHTML = "Success: Content Published!";
            statusDiv.className = "success-msg";
            document.getElementById('title').value = '';
            document.getElementById('image').value = '';
            loadAllContent();
            setTimeout(() => { statusDiv.innerHTML = ''; statusDiv.className = ''; }, 3000);
        } catch (e) { alert("Error: " + e.message); }
    }

    async function loadAllContent() {
        const container = document.getElementById('contentContainer');
        const search = document.getElementById('searchBox').value.toLowerCase();
        
        try {
            const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.title.toLowerCase().includes(search)) {
                    container.innerHTML += `
                    <div class="content-card">
                        <img src="${d.image}" class="content-poster" onerror="this.src='https://via.placeholder.com/300x180?text=No+Image'">
                        <div class="content-info">
                            <strong>${d.title}</strong><br>
                            <small style="color:var(--gray)">${d.status} | ${d.date}</small><br>
                            <button class="btn-post" style="padding:8px; margin-top:10px; font-size:13px;" onclick="openEditModal('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit Everything
                            </button>
                        </div>
                    </div>`;
                }
            });
        } catch (e) { console.log(e); }
    }

    function triggerAddEp() {
        const type = document.getElementById('newEpType').value;
        // Season filter er value jodi 'all' na hoy, tobe shei season e add hobe
        const filterVal = document.getElementById('seasonFilter').value;
        const defaultSeason = filterVal === 'all' ? '1' : filterVal;
        addEpisodeRow('', '', '', '', '', '', type, defaultSeason);
        updateSeasonFilterUI();
        applySeasonFilter();
    }

    function addEpisodeRow(name = '', l480 = '', l720 = '', l1080 = '', l2k = '', l4k = '', type = 'multi', season = '1') {
        const div = document.createElement('div');
        div.className = 'episode-row';
        div.dataset.type = type;
        
        let seasonOptions = '';
        for(let i=1; i<=30; i++) {
            seasonOptions += `<option value="${i}" ${season == i ? 'selected' : ''}>Season ${i}</option>`;
        }
        
        let linkInputs = '';
        if(type === 'multi') {
            linkInputs = `
                <div class="ep-link-grid">
                    <input type="text" placeholder="480p Link" value="${l480}" class="ep-480">
                    <input type="text" placeholder="720p Link" value="${l720}" class="ep-720">
                    <input type="text" placeholder="1080p Link" value="${l1080}" class="ep-1080">
                    <input type="text" placeholder="2K Link" value="${l2k}" class="ep-2k">
                    <input type="text" placeholder="4K Link" value="${l4k}" class="ep-4k" style="grid-column: span 2;">
                </div>`;
        } else {
            const val = l480 || l720 || l1080 || l2k || l4k;
            linkInputs = `<div class="ep-link-grid"><input type="text" placeholder="${type.toUpperCase()} Link" value="${val}" class="ep-${type}" style="grid-column: span 2;"></div>`;
        }

        div.innerHTML = `
            <button class="remove-btn" onclick="removeEpRow(this)">Remove</button>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label>Season</label>
                    <select class="ep-season" onchange="updateSeasonFilterUI(); applySeasonFilter();">${seasonOptions}</select>
                </div>
                <div style="flex: 2;">
                    <label>Episode Name / Number</label>
                    <input type="text" placeholder="e.g. Episode 01" value="${name}" class="ep-name">
                </div>
            </div>
            ${linkInputs}
        `;
        document.getElementById('episodes-list').appendChild(div);
    }

    // Season wise Filtering Functions
    function updateSeasonFilterUI() {
        const seasonSelects = document.querySelectorAll('.ep-season');
        const filterDropdown = document.getElementById('seasonFilter');
        const currentFilter = filterDropdown.value;
        
        const seasons = new Set();
        seasonSelects.forEach(s => seasons.add(s.value));
        
        // Clear except first
        filterDropdown.innerHTML = '<option value="all">Show All Seasons</option>';
        
        // Sort and Add seasons
        Array.from(seasons).sort((a,b) => a-b).forEach(s => {
            filterDropdown.innerHTML += `<option value="${s}">Season ${s}</option>`;
        });
        
        // Restore selection if exists
        filterDropdown.value = seasons.has(currentFilter) ? currentFilter : 'all';
    }

    function applySeasonFilter() {
        const filterVal = document.getElementById('seasonFilter').value;
        const rows = document.querySelectorAll('.episode-row');
        
        rows.forEach(row => {
            const rowSeason = row.querySelector('.ep-season').value;
            if(filterVal === 'all' || rowSeason === filterVal) {
                row.style.display = 'block';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function removeEpRow(btn) {
        btn.parentElement.remove();
        updateSeasonFilterUI();
        applySeasonFilter();
    }

    async function openEditModal(id) {
        const doc = await db.collection('posts').doc(id).get();
        const d = doc.data();
        
        document.getElementById('editId').value = id;
        document.getElementById('editTitle').value = d.title || '';
        document.getElementById('editImage').value = d.image || '';
        document.getElementById('editDownloadGuide').value = d.downloadGuide || '';
        document.getElementById('editStatusSelect').value = d.status || 'Ongoing';
        document.getElementById('editQuality').value = d.quality || '';
        document.getElementById('editLang').value = d.lang || '';
        document.getElementById('editGenre').value = d.genre || '';
        
        const epList = document.getElementById('episodes-list');
        epList.innerHTML = '';
        
        if(d.episodes && d.episodes.length > 0) {
            d.episodes.forEach(ep => {
                let type = 'multi';
                let linkCount = [ep.link480, ep.link720, ep.link1080, ep.link2k, ep.link4k].filter(x => x).length;
                if(linkCount === 1) {
                    if(ep.link4k) type = '4k';
                    else if(ep.link1080) type = '1080p';
                    else if(ep.link720) type = '720p';
                    else if(ep.link480) type = '480p';
                }
                addEpisodeRow(ep.name, ep.link480||'', ep.link720||'', ep.link1080||'', ep.link2k||'', ep.link4k||'', type, ep.season || '1');
            });
        }
        
        // Initialize Filter
        updateSeasonFilterUI();
        document.getElementById('seasonFilter').value = 'all';
        applySeasonFilter();
        
        document.getElementById('editModal').classList.add('active');
    }

    async function updateContent() {
        const id = document.getElementById('editId').value;
        const rows = document.querySelectorAll('.episode-row');
        let episodesArray = [];

        rows.forEach(row => {
            const name = row.querySelector('.ep-name').value;
            const season = row.querySelector('.ep-season').value;
            if(name) {
                const type = row.dataset.type;
                let epObj = { name: name, season: season };
                if(type === 'multi') {
                    epObj.link480 = row.querySelector('.ep-480').value || "";
                    epObj.link720 = row.querySelector('.ep-720').value || "";
                    epObj.link1080 = row.querySelector('.ep-1080').value || "";
                    epObj.link2k = row.querySelector('.ep-2k').value || "";
                    epObj.link4k = row.querySelector('.ep-4k').value || "";
                } else {
                    const cleanType = type.replace('p', '');
                    epObj['link' + cleanType] = row.querySelector('.ep-' + type).value || "";
                }
                episodesArray.push(epObj);
            }
        });

        try {
            await db.collection('posts').doc(id).update({
                title: document.getElementById('editTitle').value,
                image: document.getElementById('editImage').value,
                downloadGuide: document.getElementById('editDownloadGuide').value,
                status: document.getElementById('editStatusSelect').value,
                quality: document.getElementById('editQuality').value,
                lang: document.getElementById('editLang').value,
                genre: document.getElementById('editGenre').value,
                episodes: episodesArray
            });
            
            const estatus = document.getElementById('editStatus');
            estatus.innerHTML = "Everything Updated Successfully!";
            estatus.className = "success-msg";
            loadAllContent();
            setTimeout(() => { closeEditModal(); estatus.innerHTML = ''; estatus.className = ''; }, 1500);
        } catch (e) { alert("Error: " + e.message); }
    }

    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

    async function deleteContentConfirm() {
        if(confirm("Are you sure? This post will be permanently deleted!")) {
            await db.collection('posts').doc(document.getElementById('editId').value).delete();
            closeEditModal();
            loadAllContent();
        }
    }
</script>
</body>
</html>
